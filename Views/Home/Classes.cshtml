@{
    ViewData["Title"] = "Classes";
    Layout = "_Layout";
}

<div style="min-height: 90vh!important;" class="text-center row h-100">
    <h1 class="display-4">Classes</h1>
    <div id="classGridContainer"></div>
</div>

<script>
    var myModal = new bootstrap.Modal($("#globalModal"), {
        keyboard: false
    });

    var store = new DevExpress.data.CustomStore({
        key: 'classId',
        load() {
            return sendRequest("@Url.Content("~/Class/GetClasses")");
        },
        insert(values) {
            return sendRequest("@Url.Content("~/Class/AddClass")", 'POST', {
                values: JSON.stringify(values),
            });
        },
        update(key, values) {
            return sendRequest("@Url.Content("~/Class/EditClass")", 'POST', {
                key,
                values: JSON.stringify(values),
            });
        },
        remove(key) {
            return sendRequest("@Url.Content("~/Class/DeleteClass")", 'POST', {
                key,
            });
        },
    });
 
    var itemStore = new DevExpress.data.CustomStore({
        key: 'itemId',
        loadMode: 'raw',
        load() {
            return sendRequest("@Url.Content("~/Item/GetItems")");
        },
    });
    $('#classGridContainer').dxDataGrid({
        dataSource: store,
        remoteOperations: false,
        columns: [
            //{
            //    type: 'buttons',
            //    width: 110,
            //    buttons: [{
            //        hint: 'new',
            //        icon: 'plus',
            //        visible(e) {
            //            return !e.row.isEditing;
            //        },
            //        onClick(e, a, b) {
            //            console.log(e);
            //            console.log(a);
            //            console.log(b);
            //            myModal.toggle();
            //            $("#globalModalBody").load("@Url.Action("_ViewClass","Class")", { key: e.row.key });
            //        },
            //    },
            //    {
            //        hint: 'edit',
            //        icon: 'edit',
            //        visible(e) {
            //            return !e.row.isEditing;
            //        },
            //        onClick(e, a, b) {
            //            console.log(e);
            //            console.log(a);
            //            console.log(b);
            //            myModal.toggle();
            //            $("#globalModalBody").load("@Url.Action("_EditClass","Class")", { key: e.row.key });
            //        },
            //    },
            //    {
            //        hint: 'delete',
            //        icon: 'remove',
            //        visible(e) {
            //            return !e.row.isEditing;
            //        },
            //        onClick(e) {
            //            myModal.toggle();
            //            sendRequest("@Url.Content("~/Class/DeleteClass")", 'POST', { key: e.row.key });
            //        },
            //    }],
            //},
            {
                dataField: 'name',
                dataType: 'string',
            },
            {
                dataField: 'hitDie',
                dataType: 'number',
            },
            {
                dataField: 'description',
                dataType: 'string',
                formItem: {
                    colSpan: 2,
                    editorType: 'dxTextArea',
                    editorOptions: {
                        height: 100,
                    },
                }
            },
            {
                dataField: 'itemIds',
                caption: 'Armor',
                dataType: 'string',
                visible: false,
                formItem: {
                    colSpan: 2,
                    editorType: 'dxTagBox',
                    editorOptions: {
                        dataSource: new DevExpress.data.CustomStore({
                            key: 'itemId',
                            loadMode: 'raw',
                            load() {
                                return sendRequest("@Url.Content("~/Item/GetArmor")");
                            },
                        }),
                        valueExpr: 'itemId',
                        displayExpr: 'name',
                        searchEnabled: true,
                        showSelectionControls: true,
                        showDropDownButton: true,
                        applyValueMode: 'useButtons',
                    },
                },
            },
            {
                dataField: 'itemIds',
                caption: 'Weapons',
                dataType: 'string',
                visible: false,
                formItem: {
                    colSpan: 2,
                    editorType: 'dxTagBox',
                    editorOptions: {
                        dataSource: new DevExpress.data.CustomStore({
                            key: 'itemId',
                            loadMode: 'raw',
                            load() {
                                return sendRequest("@Url.Content("~/Item/GetWeapons")");
                            },
                        }),
                        valueExpr: 'itemId',
                        displayExpr: 'name',
                        searchEnabled: true,
                        showSelectionControls: true,
                        showDropDownButton: true,
                        applyValueMode: 'useButtons',
                    },
                },
            },
            {
                dataField: 'itemId',
                caption: 'Tools',
                dataType: 'string',
                visible: false,
                formItem: {
                    colSpan: 2,
                    editorType: 'dxTagBox',
                    editorOptions: {
                        dataSource: new DevExpress.data.CustomStore({
                            key: 'itemId',
                            loadMode: 'raw',
                            load() {
                                return sendRequest("@Url.Content("~/Item/GetTools")");
                            },
                        }),
                        valueExpr: 'itemId',
                        displayExpr: 'name',
                        searchEnabled: true,
                        showSelectionControls: true,
                        showDropDownButton: true,
                        applyValueMode: 'useButtons',
                    },
                },
            },
            {
                dataField: 'savingThrowIds',
                caption: 'Saving Throws',
                dataType: 'string',
                visible: false,
                formItem: {
                    colSpan: 2,
                    editorType: 'dxTagBox',
                    editorOptions: {
                        dataSource: new DevExpress.data.CustomStore({
                            key: 'savingThrowId',
                            loadMode: 'raw',
                            load() {
                                return sendRequest("@Url.Content("~/SavingThrow/GetSavingThrows")");
                            },
                        }),
                        valueExpr: 'savingThrowId',
                        displayExpr: 'name',
                        searchEnabled: true,
                        showSelectionControls: true,
                        showDropDownButton: true,
                        applyValueMode: 'useButtons',
                    },
                },
            },
            {
                dataField: 'skillIds',
                caption: 'Skills',
                dataType: 'string',
                visible: false,
                formItem: {
                    colSpan: 2,
                    editorType: 'dxTagBox',
                    editorOptions: {
                        dataSource: new DevExpress.data.CustomStore({
                            key: 'skillId',
                            loadMode: 'raw',
                            load() {
                                return sendRequest("@Url.Content("~/Skill/GetSkills")");
                            },
                        }),
                        valueExpr: 'skillId',
                        displayExpr: 'name',
                        searchEnabled: true,
                        showSelectionControls: true,
                        showDropDownButton: true,
                        applyValueMode: 'useButtons',
                    },
                },
            },
            {
                dataField: 'source',
                dataType: 'string',
            },
        ],
        paging: {
            pageSize: 10,
        },
        pager: {
            visible: true,
            allowedPageSizes: [5, 10, 25, 50, 100],
            showPageSizeSelector: true,
            showInfo: true,
            showNavigationButtons: true,
        },
        filterRow: {
            visible: true,
        },
        headerFilter: {
            visible: true,
        },
        groupPanel: {
            visible: true,
        },
        scrolling: {
            mode: 'virtual',
        },
        height: 600,
        showBorders: true,
        grouping: {
            autoExpandAll: false,
        },
        editing: {
            mode: 'form',
            allowAdding: true,
            allowUpdating: true,
            allowDeleting: true,
        },
        onRowDblClick: function (e) {
            console.log(e);
            myModal.toggle();
            $("#globalModalBody").load("@Url.Action("_ViewClass","Class")", { key: e.key });
        },
        onRowUpdating: function (e){
            console.log(e);
        }
    });
    function sendRequest(url, method = 'GET', data) {
        const d = $.Deferred();

        //logRequest(method, url, data);

        $.ajax(url, {
            method,
            data,
            cache: false,
            xhrFields: { withCredentials: true },
        }).done((result) => {
            d.resolve(method === 'GET' ? result : result);
        }).fail((xhr) => {
            d.reject(xhr.responseJSON ? xhr.responseJSON.Message : xhr.statusText);
        });

        return d.promise();
    }

    function logRequest(method, url, data) {
        const args = Object.keys(data || {}).map((key) => `${key}=${data[key]}`).join(' ');

        const logList = $('#requests ul');
        const time = DevExpress.localization.formatDate(new Date(), 'HH:mm:ss');
        const newItem = $('<li>').text([time, method, url.slice(URL.length), args].join(' '));

        logList.prepend(newItem);
    }
</script>